# 更新日志
v2.0.1(2025-07-24)
✨ 新增功能：
## 主要更新内容

### 1. 日志系统
- **变更前：**  
  使用自定义 `log_message` 函数，手动写入日志文件，无标准格式。
- **变更后：**  
  - 采用 Python 标准库 `logging`，日志输出格式化（含时间、级别、消息）。
  - `log_message` 依然存在，但实际调用的是 `logging.info()`，保证原有调用兼容。
  - 日志同时输出到控制台和 `logs/01log.log` 文件。

### 2. 超时机制
- **变更前：**  
  - 线程任务超时通过主线程 `future.result(timeout=...)` 实现，仅能检测超时，无法精细控制子线程内每条命令的超时。
  - 单条命令的超时分散写在各处，修改不便。
- **变更后：**  
  - 引入全局变量：
    - `INSPECTION_TASK_TIMEOUT`：单设备最大巡检时长（秒）。
    - `INSPECTION_CMD_TIMEOUT`：单条命令最大超时时长（秒）。
  - 在 `inspection` 函数中，命令循环前动态计算剩余超时，将 `read_timeout` 设为 `min(INSPECTION_CMD_TIMEOUT, 剩余总时长)`，保证不会因为单条命令阻塞拖慢整体超时。
  - 巡检任务超时判断更精准，便于统一修改和维护。
  - 目前的机制已是Python线程池+Netmiko的最佳实践之一。实际“整体超时”会受到命令数量和单条命令read_timeout累积影响，这是Netmiko机制决定的。

### 3. 代码结构与健壮性
- 线程池部分结构优化，采用自定义守护线程池（`DaemonThreadPoolExecutor`）。
- 日志目录、文件路径、异常处理等更规范。
- 主要配置项（路径、超时等）集中在全局变量，便于维护。
- 错误和异常日志更详细，有助于后期排查。

---

v2.0.0 (2025-06-23)
✨ 新增功能：

引入 concurrent.futures.ThreadPoolExecutor 替代手动信号量线程池，提升并发性能与可读性

新增 DaemonThreadPoolExecutor 子类，确保所有工作线程为守护线程，主线程结束时自动清理子线程

支持 info.xlsx 文件加密读取，自动提示用户输入密码，提供 3 次重试机会

支持显示命令执行实时回显（可选）

巡检命令执行逻辑增强：

针对 sys / enable 等无回显命令自动使用 send_command_timing()

自动判断回显是否为空或不生效，进行提示

兼容 Windows 7 系统，提供一键打包脚本 packet_win7.bat，可直接生成可执行文件

🧾 日志系统重构：

使用 log_message() 函数统一控制台输出和日志写入

日志分离策略：

logs/01log.log：总览异常与流程

logs/YYYY.MM.DD/host.log：每台设备独立日志

添加异常分类处理，如 NetmikoTimeoutException、AuthenticationException、Enable失败 等均有明确日志标识

🐛 问题修复：

修复部分设备因缺失字段导致程序崩溃的问题（字段完整性校验）

修复超时命令可能阻塞线程的问题，统一添加 timeout 限制

修复重复日志写入问题，每次运行前自动清空旧日志

🧹 优化改进：

所有路径均通过 get_base_dir() 动态计算，兼容 .py 与 .exe 两种运行模式

控制台输出加锁（threading.Lock）防止多线程输出混乱

异常信息输出更具可读性，便于定位具体命令或设备问题

补充大量注释，便于二次开发与维护

v1.0.0
📌 初始版本功能：

基于 Netmiko 实现网络设备 SSH 巡检

从 Excel 配置文件读取设备信息与命令

支持日志输出至 logs/ 目录

基础异常处理与线程支持（基于 threading.BoundedSemaphore）

# 历史记录（老版本格式）

## 2025.03.17

- 修改了读取info文件的代码逻辑。
- 增加了对加密info文件（Excel.xlsx文件）的支持。输入密码时有隐式输入处理，避免肩窥泄露密码。
- 加密方式：

<img src="https://github.com/icefire-ken/devices_inspection/blob/main/images/encrypt_1.png" width="400" />

<img src="https://github.com/icefire-ken/devices_inspection/blob/main/images/encrypt_2.png" width="400" />

<img src="https://github.com/icefire-ken/devices_inspection/blob/main/images/encrypt_3.png" width="400" />

## 2024.09.13

- 巡检信息文件首项记录巡检本地时间。

## 2024.08.26

- 对每个设备巡检的线程以设备名称定义线程名称，以便于定位每个线程内发生的异常。
- 修复了设备巡检时会因为回显过长导致的ReadTimeout异常，记录到巡检文件中，避免异常中断线程。
- 修复了收集巡检信息时，后一个命令在出现异常时，巡检结果会被前一个命令替代的问题。

## 2024.07.17

- 修复了因为网络不通畅导致的登录时TCP连接超时，会被记录为管理地址或端口不可达的错误。

## 2024.07.13

- 巡检开始前，需确认info文件名称，可以输入非默认info文件名称，比如info2.xlsx，但要注意扩展名。

## 2024.07.04

- 修复了CMD窗口内巡检过程实时显示，仍存在的多个设备信息在同一行显示的问题。
- 修改了延时退出的逻辑，现在需要输入Enter键退出，方便查看CMD窗口输出提示信息。

## 2024.07.03

- 增加异常捕获记录，远程登录协议错误（ConnectionRefusedError）。

## 2024.04.13

- 增加了对未知异常的处理；记录在01log文件中，方便反馈。

## 2024.04.12

- 更新项目描述文件结构。（README.md、UPDATE.md、images文件夹）

## 2024.02.02

- 修复了A10设备类型在没有配置Enable密码时，需要在info文件的Secret字段中填入空格才能正确登录的问题。
  - 不再需要空格填充Secret字段了。

## 2024.01.24

- 修改了异常捕获。
- 修改了脚本延迟退出的提醒。

## 2024.01.21

- info文件添加了Linux设备类型的示例；Secret为空；巡检命令可根据需求自行增减。

## 2024.01.20

- 增加了脚本结束的等待提醒。
- 修复了info文件给定的路径问题。

## 2024.01.19

- 使用了更多的格式化字符串，使得输出信息更清晰，脚本可读性更高。
- 在info文件设备登录信息表项中添加了port字段，为某些修改了SSH和Telnet默认端口的场景提供使用。
- 增加了脚本延迟退出，在使用.exe程序时为工程师留有充足的时间查看CMD中的输出信息。
- 修改了操作文件的路径获取方式。
- 修改了对巡检命令是否为字符串的判断。
- 修改了一些不够准确的注释。
- 修复了释放线程的结构，避免了异常退出时，可能无法释放线程的错误。
- 修复了读取info文件异常时，脚本仍然继续执行的错误。

## 2024.01.12

- 修改了获取info文件路径的方式。

## 2023.12.28

- info文件添加了部分锐捷类型设备的巡检命令。

## 2023.12.25

- 为了方便在没有Python环境的PC上使用，以将.py脚本打包成了.exe程序。
- EXE程序Release，想要直接使用的朋友可以在Releases下载EXE程序，配合info文件使用。

## 2023.06.19

- 修复了巡检命令输入等待结果时间过长的问题，大幅缩短巡检时间。
  
## 2022.11.07

- 修复了CMD窗口内巡检过程实时显示，有可能发生的多个设备信息在同一行显示的问题。

## 2022.08.12

- A10设备请注意，若Enable密码为空，则需要在info文件中的Secret列中填补空格，否则会报“登录信息错误”异常。

## 2022.06.21

- 增加了对Telnet连接超时的异常捕获，并记录到日志文件中。

## 2021.12.28

- 为项目添加requirements.txt文件，方便脚本移植。

## 2021.12.13

- 修复多线程对01log文件操作时可能出现的冲突问题。
- 修复保存的巡检文件和log文件打开时会出现乱码的问题。

## 2021.12.02

- 修复读取设备登录信息中的纯数字内容为数字类型，不能供给Netmiko使用的问题。

## 2021.11.04

- 为info文件添加需要使用telnet登录的标识。
- 为“设备管理地址不可达！”登录异常修改描述“设备管理地址或端口不可达！”。
- info文件添加了部分华三（hp_comware）类型设备的巡检命令。

## 2021.11.01

- 加入登录设备出现错误信息的记录功能，会在巡检目录下创建01log文件来记录设备登录时出现的异常。
- info文件添加了部分Cisco ASA（cisco_asa）类型设备的巡检命令。
- 修复读取巡检命令时，由于pandas出现的nan。

## 2021.10.02

- 为避免过多消耗设备性能，加入巡检最大线程限制，默认最大100个线程。
- info文件添加了部分华为（huawei）类型设备的巡检命令。

## 2021.09.17

- 初次上传脚本。
- 脚本已经实现基本功能，及多线程巡检功能。
- info文件中Sheet2只包含了cisco_ios、a10的巡检命令。
